{"version":3,"file":"index.js","sources":["../../src/produce.js"],"sourcesContent":["// produce(currentState, producer: (draftState) => void): nextState\nconst INTERNAL_STATE_KEY = Symbol('state');\n\nfunction proxyProp(propValue, propKey, hostDraftState) {\n  const { originalValue, draftValue, onWrite } = hostDraftState;\n  return proxy(propValue, (value) => {\n    if (!draftValue.mutated) {\n      hostDraftState.mutated = true;\n      // 拷贝host所有属性\n      copyProps(draftValue, originalValue);\n    }\n    draftValue[propKey] = value;\n    if (onWrite) {\n      onWrite(draftValue);\n    }\n  });\n}\n\n// 跳过target身上已有的属性\nfunction copyProps(target, source) {\n  if (Array.isArray(target)) {\n    for (let i = 0; i < source.length; i++) {\n      // 跳过在更深层已经被改过的属性\n      if (!(i in target)) {\n        target[i] = source[i];\n      }\n    }\n  }\n  else {\n    Reflect.ownKeys(source).forEach(key => {\n      const desc = Object.getOwnPropertyDescriptor(source, key);\n      // 跳过已有属性\n      if (!(key in target)) {\n        Object.defineProperty(target, key, desc);\n      }\n    });\n  }\n}\n\nfunction copyOnWrite(draftState) {\n  const { originalValue, draftValue, mutated, onWrite } = draftState;\n  if (!mutated) {\n    draftState.mutated = true;\n    // 下一层有修改时才往父级 draftValue 上挂\n    if (onWrite) {\n      onWrite(draftValue);\n    }\n    // 第一次写时复制\n    copyProps(draftValue, originalValue);\n  }\n}\n\nfunction getTarget(draftState) {\n  return draftState.mutated ? draftState.draftValue : draftState.originalValue;\n}\n\nfunction getCleanCopy(obj) {\n  return Object.create(Object.getPrototypeOf(obj));\n}\n\nfunction proxy(original, onWrite) {\n  const isArrayValue = Array.isArray(original);\n  // 创建一份干净的draft值\n  const draftValue = isArrayValue ? [] : getCleanCopy(original);\n  let proxiedKeyMap = Object.create(null);\n  let draftState = {\n    originalValue: original,\n    draftValue,\n    mutated: false,\n    onWrite\n  };\n  const draft = new Proxy(original, {\n    get(target, key, receiver) {\n      // 建立proxy到draft值的关联\n      if (key === INTERNAL_STATE_KEY) {\n        return draftState;\n      }\n      // 优先走已创建的代理\n      if (key in proxiedKeyMap) {\n        return proxiedKeyMap[key];\n      }\n\n      // 代理属性访问\n      if (typeof original[key] === 'object' && original[key] !== null) {\n        // 不为基本值类型的现有属性，创建下一层代理\n        proxiedKeyMap[key] = proxyProp(original[key], key, draftState, onWrite);\n        return proxiedKeyMap[key];\n      }\n      else {\n        // 改过直接从draft取最新状态\n        if (draftState.mutated) {\n          return draftValue[key];\n        }\n\n        // 不存在的，或者值为基本值的现有属性，代理到原值\n        return Reflect.get(target, key, receiver);\n      }\n    },\n    set(target, key, value) {\n      // 监听修改，用新值重写原值\n      // 如果新值不为基本值类型，创建下一层代理\n      if (typeof value === 'object') {\n        proxiedKeyMap[key] = proxyProp(value, key, draftState, onWrite);\n      }\n      // 第一次写时复制\n      copyOnWrite(draftState);\n      // 复制过了，直接写\n      draftValue[key] = value;\n      return true;\n    },\n    // 代理其它读方法\n    has(_, ...args) {\n      return Reflect.has(getTarget(draftState), ...args);\n    },\n    ownKeys(_, ...args) {\n      return Reflect.ownKeys(getTarget(draftState), ...args);\n    },\n    getOwnPropertyDescriptor(_, ...args) {\n      return Reflect.getOwnPropertyDescriptor(getTarget(draftState), ...args);\n    },\n    getPrototypeOf(_, ...args) {\n      return Reflect.getPrototypeOf(original, ...args);\n    },\n    // 代理其它写方法\n    deleteProperty(_, ...args) {\n      copyOnWrite(draftState);\n      return Reflect.deleteProperty(draftValue, ...args);\n    },\n    defineProperty(_, ...args) {\n      copyOnWrite(draftState);\n      return Reflect.defineProperty(draftValue, ...args);\n    },\n    setPrototypeOf(_, ...args) {\n      copyOnWrite(draftState);\n      return Reflect.setPrototypeOf(draftValue, ...args);\n    }\n  });\n\n  return draft;\n}\n\nexport default function produce(original, producer) {\n  const draft = proxy(original);\n  // 修改draft\n  producer(draft);\n  // 取出draft内部状态\n  const { originalValue, draftValue, mutated } = draft[INTERNAL_STATE_KEY];\n  // console.log('-- draftState --');\n  // console.log(draft[INTERNAL_STATE_KEY]);\n  // 将改过的新值patch上去\n  const next = mutated ? draftValue : originalValue;\n  return next;\n}\n"],"names":["INTERNAL_STATE_KEY","Symbol","proxyProp","propValue","propKey","hostDraftState","originalValue","draftValue","onWrite","proxy","value","mutated","copyProps","target","source","Array","isArray","i","length","Reflect","ownKeys","forEach","key","desc","Object","getOwnPropertyDescriptor","defineProperty","copyOnWrite","draftState","getTarget","getCleanCopy","obj","create","getPrototypeOf","original","isArrayValue","proxiedKeyMap","draft","Proxy","get","receiver","set","has","_","args","deleteProperty","setPrototypeOf","produce","producer","next"],"mappings":"AAAA;AACA,MAAMA,kBAAkB,GAAGC,MAAM,CAAC,OAAD,CAAjC;;AAEA,SAASC,SAAT,CAAmBC,SAAnB,EAA8BC,OAA9B,EAAuCC,cAAvC,EAAuD;QAC/C;IAAEC,aAAF;IAAiBC,UAAjB;IAA6BC;MAAYH,cAA/C;SACOI,KAAK,CAACN,SAAD,EAAaO,KAAD,IAAW;QAC7B,CAACH,UAAU,CAACI,OAAhB,EAAyB;MACvBN,cAAc,CAACM,OAAf,GAAyB,IAAzB,CADuB;;MAGvBC,SAAS,CAACL,UAAD,EAAaD,aAAb,CAAT;;;IAEFC,UAAU,CAACH,OAAD,CAAV,GAAsBM,KAAtB;;QACIF,OAAJ,EAAa;MACXA,OAAO,CAACD,UAAD,CAAP;;GARQ,CAAZ;;;;AAcF,SAASK,SAAT,CAAmBC,MAAnB,EAA2BC,MAA3B,EAAmC;MAC7BC,KAAK,CAACC,OAAN,CAAcH,MAAd,CAAJ,EAA2B;SACpB,IAAII,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGH,MAAM,CAACI,MAA3B,EAAmCD,CAAC,EAApC,EAAwC;;UAElC,EAAEA,CAAC,IAAIJ,MAAP,CAAJ,EAAoB;QAClBA,MAAM,CAACI,CAAD,CAAN,GAAYH,MAAM,CAACG,CAAD,CAAlB;;;GAJN,MAQK;IACHE,OAAO,CAACC,OAAR,CAAgBN,MAAhB,EAAwBO,OAAxB,CAAgCC,GAAG,IAAI;YAC/BC,IAAI,GAAGC,MAAM,CAACC,wBAAP,CAAgCX,MAAhC,EAAwCQ,GAAxC,CAAb,CADqC;;UAGjC,EAAEA,GAAG,IAAIT,MAAT,CAAJ,EAAsB;QACpBW,MAAM,CAACE,cAAP,CAAsBb,MAAtB,EAA8BS,GAA9B,EAAmCC,IAAnC;;KAJJ;;;;AAUJ,SAASI,WAAT,CAAqBC,UAArB,EAAiC;QACzB;IAAEtB,aAAF;IAAiBC,UAAjB;IAA6BI,OAA7B;IAAsCH;MAAYoB,UAAxD;;MACI,CAACjB,OAAL,EAAc;IACZiB,UAAU,CAACjB,OAAX,GAAqB,IAArB,CADY;;QAGRH,OAAJ,EAAa;MACXA,OAAO,CAACD,UAAD,CAAP;KAJU;;;IAOZK,SAAS,CAACL,UAAD,EAAaD,aAAb,CAAT;;;;AAIJ,SAASuB,SAAT,CAAmBD,UAAnB,EAA+B;SACtBA,UAAU,CAACjB,OAAX,GAAqBiB,UAAU,CAACrB,UAAhC,GAA6CqB,UAAU,CAACtB,aAA/D;;;AAGF,SAASwB,YAAT,CAAsBC,GAAtB,EAA2B;SAClBP,MAAM,CAACQ,MAAP,CAAcR,MAAM,CAACS,cAAP,CAAsBF,GAAtB,CAAd,CAAP;;;AAGF,SAAStB,KAAT,CAAeyB,QAAf,EAAyB1B,OAAzB,EAAkC;QAC1B2B,YAAY,GAAGpB,KAAK,CAACC,OAAN,CAAckB,QAAd,CAArB,CADgC;;QAG1B3B,UAAU,GAAG4B,YAAY,GAAG,EAAH,GAAQL,YAAY,CAACI,QAAD,CAAnD;MACIE,aAAa,GAAGZ,MAAM,CAACQ,MAAP,CAAc,IAAd,CAApB;MACIJ,UAAU,GAAG;IACftB,aAAa,EAAE4B,QADA;IAEf3B,UAFe;IAGfI,OAAO,EAAE,KAHM;IAIfH;GAJF;QAMM6B,KAAK,GAAG,IAAIC,KAAJ,CAAUJ,QAAV,EAAoB;IAChCK,GAAG,CAAC1B,MAAD,EAASS,GAAT,EAAckB,QAAd,EAAwB;;UAErBlB,GAAG,KAAKtB,kBAAZ,EAAgC;eACvB4B,UAAP;OAHuB;;;UAMrBN,GAAG,IAAIc,aAAX,EAA0B;eACjBA,aAAa,CAACd,GAAD,CAApB;OAPuB;;;UAWrB,OAAOY,QAAQ,CAACZ,GAAD,CAAf,KAAyB,QAAzB,IAAqCY,QAAQ,CAACZ,GAAD,CAAR,KAAkB,IAA3D,EAAiE;;QAE/Dc,aAAa,CAACd,GAAD,CAAb,GAAqBpB,SAAS,CAACgC,QAAQ,CAACZ,GAAD,CAAT,EAAgBA,GAAhB,EAAqBM,UAArB,EAAiCpB,OAAjC,CAA9B;eACO4B,aAAa,CAACd,GAAD,CAApB;OAHF,MAKK;;YAECM,UAAU,CAACjB,OAAf,EAAwB;iBACfJ,UAAU,CAACe,GAAD,CAAjB;SAHC;;;eAOIH,OAAO,CAACoB,GAAR,CAAY1B,MAAZ,EAAoBS,GAApB,EAAyBkB,QAAzB,CAAP;;KAxB4B;;IA2BhCC,GAAG,CAAC5B,MAAD,EAASS,GAAT,EAAcZ,KAAd,EAAqB;;;UAGlB,OAAOA,KAAP,KAAiB,QAArB,EAA+B;QAC7B0B,aAAa,CAACd,GAAD,CAAb,GAAqBpB,SAAS,CAACQ,KAAD,EAAQY,GAAR,EAAaM,UAAb,EAAyBpB,OAAzB,CAA9B;OAJoB;;;MAOtBmB,WAAW,CAACC,UAAD,CAAX,CAPsB;;MAStBrB,UAAU,CAACe,GAAD,CAAV,GAAkBZ,KAAlB;aACO,IAAP;KArC8B;;;IAwChCgC,GAAG,CAACC,CAAD,EAAI,GAAGC,IAAP,EAAa;aACPzB,OAAO,CAACuB,GAAR,CAAYb,SAAS,CAACD,UAAD,CAArB,EAAmC,GAAGgB,IAAtC,CAAP;KAzC8B;;IA2ChCxB,OAAO,CAACuB,CAAD,EAAI,GAAGC,IAAP,EAAa;aACXzB,OAAO,CAACC,OAAR,CAAgBS,SAAS,CAACD,UAAD,CAAzB,EAAuC,GAAGgB,IAA1C,CAAP;KA5C8B;;IA8ChCnB,wBAAwB,CAACkB,CAAD,EAAI,GAAGC,IAAP,EAAa;aAC5BzB,OAAO,CAACM,wBAAR,CAAiCI,SAAS,CAACD,UAAD,CAA1C,EAAwD,GAAGgB,IAA3D,CAAP;KA/C8B;;IAiDhCX,cAAc,CAACU,CAAD,EAAI,GAAGC,IAAP,EAAa;aAClBzB,OAAO,CAACc,cAAR,CAAuBC,QAAvB,EAAiC,GAAGU,IAApC,CAAP;KAlD8B;;;IAqDhCC,cAAc,CAACF,CAAD,EAAI,GAAGC,IAAP,EAAa;MACzBjB,WAAW,CAACC,UAAD,CAAX;aACOT,OAAO,CAAC0B,cAAR,CAAuBtC,UAAvB,EAAmC,GAAGqC,IAAtC,CAAP;KAvD8B;;IAyDhClB,cAAc,CAACiB,CAAD,EAAI,GAAGC,IAAP,EAAa;MACzBjB,WAAW,CAACC,UAAD,CAAX;aACOT,OAAO,CAACO,cAAR,CAAuBnB,UAAvB,EAAmC,GAAGqC,IAAtC,CAAP;KA3D8B;;IA6DhCE,cAAc,CAACH,CAAD,EAAI,GAAGC,IAAP,EAAa;MACzBjB,WAAW,CAACC,UAAD,CAAX;aACOT,OAAO,CAAC2B,cAAR,CAAuBvC,UAAvB,EAAmC,GAAGqC,IAAtC,CAAP;;;GA/DU,CAAd;SAmEOP,KAAP;;;AAGF,AAAe,SAASU,OAAT,CAAiBb,QAAjB,EAA2Bc,QAA3B,EAAqC;QAC5CX,KAAK,GAAG5B,KAAK,CAACyB,QAAD,CAAnB,CADkD;;EAGlDc,QAAQ,CAACX,KAAD,CAAR,CAHkD;;QAK5C;IAAE/B,aAAF;IAAiBC,UAAjB;IAA6BI;MAAY0B,KAAK,CAACrC,kBAAD,CAApD,CALkD;;;;QAS5CiD,IAAI,GAAGtC,OAAO,GAAGJ,UAAH,GAAgBD,aAApC;SACO2C,IAAP;;;;;"}