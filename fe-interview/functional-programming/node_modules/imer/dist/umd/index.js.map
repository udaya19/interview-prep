{"version":3,"file":"index.js","sources":["../../src/produce.js"],"sourcesContent":["// produce(currentState, producer: (draftState) => void): nextState\nconst INTERNAL_STATE_KEY = Symbol('state');\n\nfunction proxyProp(propValue, propKey, hostDraftState) {\n  const { originalValue, draftValue, onWrite } = hostDraftState;\n  return proxy(propValue, (value) => {\n    if (!draftValue.mutated) {\n      hostDraftState.mutated = true;\n      // 拷贝host所有属性\n      copyProps(draftValue, originalValue);\n    }\n    draftValue[propKey] = value;\n    if (onWrite) {\n      onWrite(draftValue);\n    }\n  });\n}\n\n// 跳过target身上已有的属性\nfunction copyProps(target, source) {\n  if (Array.isArray(target)) {\n    for (let i = 0; i < source.length; i++) {\n      // 跳过在更深层已经被改过的属性\n      if (!(i in target)) {\n        target[i] = source[i];\n      }\n    }\n  }\n  else {\n    Reflect.ownKeys(source).forEach(key => {\n      const desc = Object.getOwnPropertyDescriptor(source, key);\n      // 跳过已有属性\n      if (!(key in target)) {\n        Object.defineProperty(target, key, desc);\n      }\n    });\n  }\n}\n\nfunction copyOnWrite(draftState) {\n  const { originalValue, draftValue, mutated, onWrite } = draftState;\n  if (!mutated) {\n    draftState.mutated = true;\n    // 下一层有修改时才往父级 draftValue 上挂\n    if (onWrite) {\n      onWrite(draftValue);\n    }\n    // 第一次写时复制\n    copyProps(draftValue, originalValue);\n  }\n}\n\nfunction getTarget(draftState) {\n  return draftState.mutated ? draftState.draftValue : draftState.originalValue;\n}\n\nfunction getCleanCopy(obj) {\n  return Object.create(Object.getPrototypeOf(obj));\n}\n\nfunction proxy(original, onWrite) {\n  const isArrayValue = Array.isArray(original);\n  // 创建一份干净的draft值\n  const draftValue = isArrayValue ? [] : getCleanCopy(original);\n  let proxiedKeyMap = Object.create(null);\n  let draftState = {\n    originalValue: original,\n    draftValue,\n    mutated: false,\n    onWrite\n  };\n  const draft = new Proxy(original, {\n    get(target, key, receiver) {\n      // 建立proxy到draft值的关联\n      if (key === INTERNAL_STATE_KEY) {\n        return draftState;\n      }\n      // 优先走已创建的代理\n      if (key in proxiedKeyMap) {\n        return proxiedKeyMap[key];\n      }\n\n      // 代理属性访问\n      if (typeof original[key] === 'object' && original[key] !== null) {\n        // 不为基本值类型的现有属性，创建下一层代理\n        proxiedKeyMap[key] = proxyProp(original[key], key, draftState, onWrite);\n        return proxiedKeyMap[key];\n      }\n      else {\n        // 改过直接从draft取最新状态\n        if (draftState.mutated) {\n          return draftValue[key];\n        }\n\n        // 不存在的，或者值为基本值的现有属性，代理到原值\n        return Reflect.get(target, key, receiver);\n      }\n    },\n    set(target, key, value) {\n      // 监听修改，用新值重写原值\n      // 如果新值不为基本值类型，创建下一层代理\n      if (typeof value === 'object') {\n        proxiedKeyMap[key] = proxyProp(value, key, draftState, onWrite);\n      }\n      // 第一次写时复制\n      copyOnWrite(draftState);\n      // 复制过了，直接写\n      draftValue[key] = value;\n      return true;\n    },\n    // 代理其它读方法\n    has(_, ...args) {\n      return Reflect.has(getTarget(draftState), ...args);\n    },\n    ownKeys(_, ...args) {\n      return Reflect.ownKeys(getTarget(draftState), ...args);\n    },\n    getOwnPropertyDescriptor(_, ...args) {\n      return Reflect.getOwnPropertyDescriptor(getTarget(draftState), ...args);\n    },\n    getPrototypeOf(_, ...args) {\n      return Reflect.getPrototypeOf(original, ...args);\n    },\n    // 代理其它写方法\n    deleteProperty(_, ...args) {\n      copyOnWrite(draftState);\n      return Reflect.deleteProperty(draftValue, ...args);\n    },\n    defineProperty(_, ...args) {\n      copyOnWrite(draftState);\n      return Reflect.defineProperty(draftValue, ...args);\n    },\n    setPrototypeOf(_, ...args) {\n      copyOnWrite(draftState);\n      return Reflect.setPrototypeOf(draftValue, ...args);\n    }\n  });\n\n  return draft;\n}\n\nexport default function produce(original, producer) {\n  const draft = proxy(original);\n  // 修改draft\n  producer(draft);\n  // 取出draft内部状态\n  const { originalValue, draftValue, mutated } = draft[INTERNAL_STATE_KEY];\n  // console.log('-- draftState --');\n  // console.log(draft[INTERNAL_STATE_KEY]);\n  // 将改过的新值patch上去\n  const next = mutated ? draftValue : originalValue;\n  return next;\n}\n"],"names":["INTERNAL_STATE_KEY","Symbol","proxyProp","propValue","propKey","hostDraftState","originalValue","draftValue","onWrite","proxy","value","mutated","copyProps","target","source","Array","isArray","i","length","Reflect","ownKeys","forEach","key","desc","Object","getOwnPropertyDescriptor","defineProperty","copyOnWrite","draftState","getTarget","getCleanCopy","obj","create","getPrototypeOf","original","isArrayValue","proxiedKeyMap","draft","Proxy","get","receiver","set","has","_","args","deleteProperty","setPrototypeOf","produce","producer","next"],"mappings":"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"}