{"version":3,"file":"index.min.js","sources":["../../src/produce.js"],"sourcesContent":["// produce(currentState, producer: (draftState) => void): nextState\nconst INTERNAL_STATE_KEY = Symbol('state');\n\nfunction proxyProp(propValue, propKey, hostDraftState) {\n  const { originalValue, draftValue, onWrite } = hostDraftState;\n  return proxy(propValue, (value) => {\n    if (!draftValue.mutated) {\n      hostDraftState.mutated = true;\n      // 拷贝host所有属性\n      copyProps(draftValue, originalValue);\n    }\n    draftValue[propKey] = value;\n    if (onWrite) {\n      onWrite(draftValue);\n    }\n  });\n}\n\n// 跳过target身上已有的属性\nfunction copyProps(target, source) {\n  if (Array.isArray(target)) {\n    for (let i = 0; i < source.length; i++) {\n      // 跳过在更深层已经被改过的属性\n      if (!(i in target)) {\n        target[i] = source[i];\n      }\n    }\n  }\n  else {\n    Reflect.ownKeys(source).forEach(key => {\n      const desc = Object.getOwnPropertyDescriptor(source, key);\n      // 跳过已有属性\n      if (!(key in target)) {\n        Object.defineProperty(target, key, desc);\n      }\n    });\n  }\n}\n\nfunction copyOnWrite(draftState) {\n  const { originalValue, draftValue, mutated, onWrite } = draftState;\n  if (!mutated) {\n    draftState.mutated = true;\n    // 下一层有修改时才往父级 draftValue 上挂\n    if (onWrite) {\n      onWrite(draftValue);\n    }\n    // 第一次写时复制\n    copyProps(draftValue, originalValue);\n  }\n}\n\nfunction getTarget(draftState) {\n  return draftState.mutated ? draftState.draftValue : draftState.originalValue;\n}\n\nfunction getCleanCopy(obj) {\n  return Object.create(Object.getPrototypeOf(obj));\n}\n\nfunction proxy(original, onWrite) {\n  const isArrayValue = Array.isArray(original);\n  // 创建一份干净的draft值\n  const draftValue = isArrayValue ? [] : getCleanCopy(original);\n  let proxiedKeyMap = Object.create(null);\n  let draftState = {\n    originalValue: original,\n    draftValue,\n    mutated: false,\n    onWrite\n  };\n  const draft = new Proxy(original, {\n    get(target, key, receiver) {\n      // 建立proxy到draft值的关联\n      if (key === INTERNAL_STATE_KEY) {\n        return draftState;\n      }\n      // 优先走已创建的代理\n      if (key in proxiedKeyMap) {\n        return proxiedKeyMap[key];\n      }\n\n      // 代理属性访问\n      if (typeof original[key] === 'object' && original[key] !== null) {\n        // 不为基本值类型的现有属性，创建下一层代理\n        proxiedKeyMap[key] = proxyProp(original[key], key, draftState, onWrite);\n        return proxiedKeyMap[key];\n      }\n      else {\n        // 改过直接从draft取最新状态\n        if (draftState.mutated) {\n          return draftValue[key];\n        }\n\n        // 不存在的，或者值为基本值的现有属性，代理到原值\n        return Reflect.get(target, key, receiver);\n      }\n    },\n    set(target, key, value) {\n      // 监听修改，用新值重写原值\n      // 如果新值不为基本值类型，创建下一层代理\n      if (typeof value === 'object') {\n        proxiedKeyMap[key] = proxyProp(value, key, draftState, onWrite);\n      }\n      // 第一次写时复制\n      copyOnWrite(draftState);\n      // 复制过了，直接写\n      draftValue[key] = value;\n      return true;\n    },\n    // 代理其它读方法\n    has(_, ...args) {\n      return Reflect.has(getTarget(draftState), ...args);\n    },\n    ownKeys(_, ...args) {\n      return Reflect.ownKeys(getTarget(draftState), ...args);\n    },\n    getOwnPropertyDescriptor(_, ...args) {\n      return Reflect.getOwnPropertyDescriptor(getTarget(draftState), ...args);\n    },\n    getPrototypeOf(_, ...args) {\n      return Reflect.getPrototypeOf(original, ...args);\n    },\n    // 代理其它写方法\n    deleteProperty(_, ...args) {\n      copyOnWrite(draftState);\n      return Reflect.deleteProperty(draftValue, ...args);\n    },\n    defineProperty(_, ...args) {\n      copyOnWrite(draftState);\n      return Reflect.defineProperty(draftValue, ...args);\n    },\n    setPrototypeOf(_, ...args) {\n      copyOnWrite(draftState);\n      return Reflect.setPrototypeOf(draftValue, ...args);\n    }\n  });\n\n  return draft;\n}\n\nexport default function produce(original, producer) {\n  const draft = proxy(original);\n  // 修改draft\n  producer(draft);\n  // 取出draft内部状态\n  const { originalValue, draftValue, mutated } = draft[INTERNAL_STATE_KEY];\n  // console.log('-- draftState --');\n  // console.log(draft[INTERNAL_STATE_KEY]);\n  // 将改过的新值patch上去\n  const next = mutated ? draftValue : originalValue;\n  return next;\n}\n"],"names":["INTERNAL_STATE_KEY","Symbol","proxyProp","propValue","propKey","hostDraftState","originalValue","draftValue","onWrite","proxy","value","mutated","copyProps","target","source","Array","isArray","i","length","Reflect","ownKeys","forEach","key","desc","Object","getOwnPropertyDescriptor","defineProperty","copyOnWrite","draftState","getTarget","original","obj","create","getPrototypeOf","getCleanCopy","proxiedKeyMap","Proxy","get","receiver","_typeof","set","has","_","args","deleteProperty","setPrototypeOf","producer","draft"],"mappings":"4ZACA,IAAMA,EAAqBC,OAAO,SAElC,SAASC,EAAUC,EAAWC,EAASC,OAC7BC,EAAuCD,EAAvCC,cAAeC,EAAwBF,EAAxBE,WAAYC,EAAYH,EAAZG,eAC5BC,EAAMN,EAAW,SAACO,GAClBH,EAAWI,UACdN,EAAeM,SAAU,EAEzBC,EAAUL,EAAYD,IAExBC,EAAWH,GAAWM,EAClBF,GACFA,EAAQD,KAMd,SAASK,EAAUC,EAAQC,MACrBC,MAAMC,QAAQH,OACX,IAAII,EAAI,EAAGA,EAAIH,EAAOI,OAAQD,IAE3BA,KAAKJ,IACTA,EAAOI,GAAKH,EAAOG,SAKvBE,QAAQC,QAAQN,GAAQO,QAAQ,SAAAC,OACxBC,EAAOC,OAAOC,yBAAyBX,EAAQQ,GAE/CA,KAAOT,GACXW,OAAOE,eAAeb,EAAQS,EAAKC,KAM3C,SAASI,EAAYC,OACXtB,EAAgDsB,EAAhDtB,cAAeC,EAAiCqB,EAAjCrB,WAAYI,EAAqBiB,EAArBjB,QAASH,EAAYoB,EAAZpB,QACvCG,IACHiB,EAAWjB,SAAU,EAEjBH,GACFA,EAAQD,GAGVK,EAAUL,EAAYD,IAI1B,SAASuB,EAAUD,UACVA,EAAWjB,QAAUiB,EAAWrB,WAAaqB,EAAWtB,cAOjE,SAASG,EAAMqB,EAAUtB,OAGjBD,EAFeQ,MAAMC,QAAQc,GAED,GAPpC,SAAsBC,UACbP,OAAOQ,OAAOR,OAAOS,eAAeF,IAMJG,CAAaJ,GAChDK,EAAgBX,OAAOQ,OAAO,MAC9BJ,EAAa,CACftB,cAAewB,EACfvB,WAAAA,EACAI,SAAS,EACTH,QAAAA,UAEY,IAAI4B,MAAMN,EAAU,CAChCO,aAAIxB,EAAQS,EAAKgB,UAEXhB,IAAQtB,EACH4B,EAGLN,KAAOa,EACFA,EAAcb,GAIM,WAAzBiB,EAAOT,EAASR,KAAuC,OAAlBQ,EAASR,IAEhDa,EAAcb,GAAOpB,EAAU4B,EAASR,GAAMA,EAAKM,GAC5CO,EAAcb,IAIjBM,EAAWjB,QACNJ,EAAWe,GAIbH,QAAQkB,IAAIxB,EAAQS,EAAKgB,IAGpCE,aAAI3B,EAAQS,EAAKZ,SAGM,WAAjB6B,EAAO7B,KACTyB,EAAcb,GAAOpB,EAAUQ,EAAOY,EAAKM,IAG7CD,EAAYC,GAEZrB,EAAWe,GAAOZ,GACX,GAGT+B,aAAIC,8BAAMC,mCAAAA,2BACDxB,QAAQsB,UAARtB,SAAYU,EAAUD,WAAgBe,KAE/CvB,iBAAQsB,8BAAMC,mCAAAA,2BACLxB,QAAQC,cAARD,SAAgBU,EAAUD,WAAgBe,KAEnDlB,kCAAyBiB,8BAAMC,mCAAAA,2BACtBxB,QAAQM,+BAARN,SAAiCU,EAAUD,WAAgBe,KAEpEV,wBAAeS,8BAAMC,mCAAAA,2BACZxB,QAAQc,qBAARd,SAAuBW,UAAaa,KAG7CC,wBAAeF,GACbf,EAAYC,8BADOe,mCAAAA,2BAEZxB,QAAQyB,qBAARzB,SAAuBZ,UAAeoC,KAE/CjB,wBAAegB,GACbf,EAAYC,8BADOe,mCAAAA,2BAEZxB,QAAQO,qBAARP,SAAuBZ,UAAeoC,KAE/CE,wBAAeH,GACbf,EAAYC,8BADOe,mCAAAA,2BAEZxB,QAAQ0B,qBAAR1B,SAAuBZ,UAAeoC,iBAOpC,SAAiBb,EAAUgB,OAClCC,EAAQtC,EAAMqB,GAEpBgB,EAASC,SAEsCA,EAAM/C,GAA7CM,IAAAA,cAAeC,IAAAA,oBAAYI,QAIZJ,EAAaD"}